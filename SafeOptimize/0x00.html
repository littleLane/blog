<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript 加载与执行 | LittleLane</title>
    <meta name="description" content="LittleLane的博客">
    <link rel="manifest" href="/blog/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.fb084c9e.css" as="style"><link rel="preload" href="/blog/assets/js/app.8628b115.js" as="script"><link rel="preload" href="/blog/assets/js/27.0fc3d0a8.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.7c696101.js"><link rel="prefetch" href="/blog/assets/js/11.0789c73b.js"><link rel="prefetch" href="/blog/assets/js/12.461a1f52.js"><link rel="prefetch" href="/blog/assets/js/13.fe3225de.js"><link rel="prefetch" href="/blog/assets/js/14.90707970.js"><link rel="prefetch" href="/blog/assets/js/15.fe5adc74.js"><link rel="prefetch" href="/blog/assets/js/16.0ebb9344.js"><link rel="prefetch" href="/blog/assets/js/17.9ccc244d.js"><link rel="prefetch" href="/blog/assets/js/18.3280c375.js"><link rel="prefetch" href="/blog/assets/js/19.497df057.js"><link rel="prefetch" href="/blog/assets/js/2.a2883561.js"><link rel="prefetch" href="/blog/assets/js/20.32678c14.js"><link rel="prefetch" href="/blog/assets/js/21.1423f536.js"><link rel="prefetch" href="/blog/assets/js/22.f2e999a8.js"><link rel="prefetch" href="/blog/assets/js/23.ba5456dd.js"><link rel="prefetch" href="/blog/assets/js/24.506605c5.js"><link rel="prefetch" href="/blog/assets/js/25.a207ec0f.js"><link rel="prefetch" href="/blog/assets/js/26.2ef516a2.js"><link rel="prefetch" href="/blog/assets/js/28.857b9f54.js"><link rel="prefetch" href="/blog/assets/js/29.ddc54fa4.js"><link rel="prefetch" href="/blog/assets/js/3.03546f42.js"><link rel="prefetch" href="/blog/assets/js/30.d40e6ea0.js"><link rel="prefetch" href="/blog/assets/js/31.1195eb55.js"><link rel="prefetch" href="/blog/assets/js/32.8de16a5a.js"><link rel="prefetch" href="/blog/assets/js/33.7cd7fe57.js"><link rel="prefetch" href="/blog/assets/js/34.738f5bc5.js"><link rel="prefetch" href="/blog/assets/js/35.77dd47e7.js"><link rel="prefetch" href="/blog/assets/js/36.352ec5b1.js"><link rel="prefetch" href="/blog/assets/js/37.13db91e9.js"><link rel="prefetch" href="/blog/assets/js/38.c6fc1157.js"><link rel="prefetch" href="/blog/assets/js/39.8c2096af.js"><link rel="prefetch" href="/blog/assets/js/4.230e5792.js"><link rel="prefetch" href="/blog/assets/js/40.b2aa99ad.js"><link rel="prefetch" href="/blog/assets/js/41.b6c8edd8.js"><link rel="prefetch" href="/blog/assets/js/42.44ad0cc7.js"><link rel="prefetch" href="/blog/assets/js/43.fb6bd8dc.js"><link rel="prefetch" href="/blog/assets/js/44.f45a0bfd.js"><link rel="prefetch" href="/blog/assets/js/45.3ac2cc18.js"><link rel="prefetch" href="/blog/assets/js/46.763aa6cb.js"><link rel="prefetch" href="/blog/assets/js/47.949030e9.js"><link rel="prefetch" href="/blog/assets/js/48.54ad9db1.js"><link rel="prefetch" href="/blog/assets/js/5.e8583280.js"><link rel="prefetch" href="/blog/assets/js/6.34b724f6.js"><link rel="prefetch" href="/blog/assets/js/7.1c9ebf74.js"><link rel="prefetch" href="/blog/assets/js/8.928845ca.js"><link rel="prefetch" href="/blog/assets/js/9.aac799a8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.fb084c9e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">LittleLane</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/AboutMe/" class="nav-link">关于我</a></div> <a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/AboutMe/" class="nav-link">关于我</a></div> <a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div class="carbon-ads"></div> <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/" class="sidebar-link">Home</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/JavaScript/0x00.html" class="sidebar-link">函数一等公民</a></li><li><a href="/blog/JavaScript/0x01.html" class="sidebar-link">回调函数详解</a></li><li><a href="/blog/JavaScript/0x02.html" class="sidebar-link">高阶函数</a></li><li><a href="/blog/JavaScript/0x03.html" class="sidebar-link">重学 new 操作符</a></li><li><a href="/blog/JavaScript/0x04.html" class="sidebar-link">重学 call、apply</a></li><li><a href="/blog/JavaScript/0x05.html" class="sidebar-link">重学 bind</a></li><li><a href="/blog/JavaScript/0x06.html" class="sidebar-link">重学 Array 之基础概念</a></li><li><a href="/blog/JavaScript/0x07.html" class="sidebar-link">重学 Array 之元素增删</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>DSA</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/" class="sidebar-link">Home</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Node.js</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/" class="sidebar-link">Home</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Tools</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/Tools/Vue-0x00.html" class="sidebar-link">Vue 组件通信详解</a></li><li><a href="/blog/Tools/Vue-0x01.html" class="sidebar-link">v-model 实现原理</a></li><li><a href="/blog/Tools/Vue-0x02.html" class="sidebar-link">Vue $dispatch 和 $broadcast</a></li><li><a href="/blog/Tools/Vue-0x03.html" class="sidebar-link">Vue v-model 源码解析</a></li><li><a href="/blog/Tools/Vue-0x04.html" class="sidebar-link">v-model 后续 input and change</a></li><li><a href="/blog/Tools/Vue-0x05.html" class="sidebar-link">Vue 生命周期详解</a></li><li><a href="/blog/Tools/Vue-0x06.html" class="sidebar-link">Vue.use() 做了什么？</a></li><li><a href="/blog/Tools/Vue-0x07.html" class="sidebar-link">Vue Router 实现剖析之一</a></li><li><a href="/blog/Tools/Vue-0x08.html" class="sidebar-link">Vue Router 实现剖析之二</a></li><li><a href="/blog/Tools/Vue-0x09.html" class="sidebar-link">Vue Router 实现剖析之三</a></li><li><a href="/blog/Tools/Vue-0x0A.html" class="sidebar-link">Vue Router 实现剖析之五</a></li><li><a href="/blog/Tools/Vue-0x0B.html" class="sidebar-link">数据响应式初探</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>DailyQuestion</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/DailyQuestion/0x00.html" class="sidebar-link">['1', '2', '3'].map(parseInt)</a></li><li><a href="/blog/DailyQuestion/0x01.html" class="sidebar-link">git ssh Permission denied</a></li><li><a href="/blog/DailyQuestion/0x02.html" class="sidebar-link">0.1 + 0.2 !== 0.3</a></li><li><a href="/blog/DailyQuestion/0x03.html" class="sidebar-link">聊聊 a 标签 rel 属性值</a></li><li><a href="/blog/DailyQuestion/0x04.html" class="sidebar-link">浏览器路由 API 详解</a></li><li><a href="/blog/DailyQuestion/0x05.html" class="sidebar-link">VSCode nvm 问题</a></li><li><a href="/blog/DailyQuestion/0x06.html" class="sidebar-link">涉及 new 、this、以及原型链经典习题</a></li><li><a href="/blog/DailyQuestion/0x07.html" class="sidebar-link">DBeaver MySQL 问题集</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>BestPractices</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/" class="sidebar-link">Home</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>SafeOptimize</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/SafeOptimize/0x00.html" class="active sidebar-link">JavaScript 加载与执行</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/SafeOptimize/0x01.html" class="sidebar-link">函数节流</a></li><li><a href="/blog/SafeOptimize/0x02.html" class="sidebar-link">XSS（Cross-Site Scripting）</a></li><li><a href="/blog/SafeOptimize/0x03.html" class="sidebar-link">CSRF(Cross-Site Request Forgery)</a></li><li><a href="/blog/SafeOptimize/0x04.html" class="sidebar-link">深入函数节流</a></li><li><a href="/blog/SafeOptimize/0x05.html" class="sidebar-link">js 异步加载之 async 和 defer</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="javascript-加载与执行"><a href="#javascript-加载与执行" aria-hidden="true" class="header-anchor">#</a> JavaScript 加载与执行</h1> <p>仿佛是与生俱来的 - JavaScript 一诞生就会出现很多的性能问题。语言本身的阻塞特性再加上浏览器使用了单一的进程处理用户界面（UI）刷新和 JavaScript 脚本执行，这导致同一时刻浏览器只会做一件事情，JavaScript 脚本执行过程耗时越长，浏览器等待响应的时间就越长。</p> <p>众所周知，在 HTML 页面结构代码中我们是通过 <code>&lt;script&gt;</code> 标签引入 JavaScript 脚本的。</p> <p>有形如</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>[url]<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>直接引入 JavaScript 脚本源文件地址</p> <p>还有形如</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;The date is &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>直接内嵌 JavaScript 脚本</p> <p>浏览器为了保证页面处理正常，当页面解析到 <code>&lt;script&gt;</code> 标签时，就会停止对页面的处理，先执行 JavaScript 脚本，等脚本执行完后，继续解析和渲染页面结构。看到这里，相信会有人问：浏览器为什么会这样处理，一溜执行下去不好吗？接下来上代码！！！</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
            document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;The date is &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDateString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>对于上面的这段代码，当浏览器解析到</p> <p>标签这里，发现里面有个叫 <code>&lt;script&gt;</code> 的标签，浏览器是不知道这个叫 <code>&lt;script&gt;</code> 的标签它葫芦里卖得什么药的（是否会对已经解析过得标签进行修改）。为了搞清楚这只葫芦里面的问题，浏览器必须停下来一心一意的处理这个葫芦，等这块的 JavaScript 脚本执行，然后继续往下进行解析和渲染。这样一方面保证了整个页面的完整性和统一性，另一方面也保证了整个页面的顺利解析。</p> <p>走到这里，我们不禁会问，这个脚本的加载和解析竟然会这么麻烦，怎样才能最大程度的减少解析脚本的耗时，从而进行最大程度的优化呢？</p> <p><a name="fQUoC"></a></p> <h3 id="脚本位置"><a href="#脚本位置" aria-hidden="true" class="header-anchor">#</a> <a href="#%E8%84%9A%E6%9C%AC%E4%BD%8D%E7%BD%AE"></a>脚本位置</h3> <p>说到这个脚本放置的位置，曾几何时，我也经常纠结于将 <code>&lt;script&gt;</code> 标签放在什么地方？</p> <p>根据 HTML4 规范给出 <code>&lt;script&gt;</code> 标签可以放在 <code>&lt;head&gt;</code> 或 <code>&lt;body&gt;</code> 标签里面，并允许出现多次。一般认为将作为 JavaScript 脚本引入的 <code>&lt;script&gt;</code> 标签和作为 <code>CSS</code> 样式文件引入的 <code>&lt;link&gt;</code> 标签同时放在 <code>&lt;head&gt;</code> 标签里面，形如：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file1.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file2.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file1.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>由于 JavaScript 脚本的阻塞特性，浏览器解析上面代码是按由上到下的顺序解析的。当解析到 <code>&lt;script&gt;</code> 标签时，浏览器会停止页面的渲染，一心一意对每个 <code>&lt;script&gt;</code> 标签进行下载、解析，这样一来用户的体验效果就会收到很明显的影响，更有可能出现页面显示空白的现象。</p> <p><img src="https://cdn.nlark.com/yuque/0/2018/png/114852/1540803268506-a287f00e-2b2d-49fb-8486-a09bad08186c.png#align=left&display=inline&height=494&originHeight=494&originWidth=1074&status=done&width=447" alt></p> <p>为此，IE8/Firefox 3.5/Safari 4/Chrome 2 都允许 JavaScript 文件的并行下载，但是在 JavaScript 文件下载的过程中仍然会阻塞其他资源的下载。不得已，推荐将所有的 <code>&lt;script&gt;</code> 标签尽可能的放到 <code>&lt;body&gt;</code> 标签的底部，以便尽量减少对整个页面渲染的影响，形如：</p> <div class="language-html extra-class"><pre class="language-html"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- other html tags --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file1.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file2.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这样做的优点：1、因为浏览器解析、渲染页面是由上至下的顺序，让 JavaScript 脚本在 DOM 解析完之后下载并解析，保证了整体页面渲染的一致性和顺序性，避免了因 JavaScript 脚本中途解析导致页面显示得不正常和 DOM 节点获取不到的异常，2、避免了因 JavaScript 文件的阻塞特性，导致整体 HTML 渲染的性能问题。</p> <p><a name="5WJyG"></a></p> <h3 id="组织脚本"><a href="#组织脚本" aria-hidden="true" class="header-anchor">#</a> <a href="#%E7%BB%84%E7%BB%87%E8%84%9A%E6%9C%AC"></a>组织脚本</h3> <p>由于每个 <code>&lt;script&gt;</code> 标签初始下载时都会阻塞页面渲染，所以减少页面包含的 <code>&lt;script&gt;</code> 标签数量有助于改善页面渲染性能问题。对于外链的 JavaScript 文件，HTTP 请求会存在额外的性能开销，因此下载一个 100KB 的文件比下载 4 个 25KB 的文件会更快。</p> <p>接下来，通过各种无阻塞模式来优化脚本文件下载解析的性能问题。</p> <p><a name="ciFN5"></a></p> <h3 id="延迟脚本"><a href="#延迟脚本" aria-hidden="true" class="header-anchor">#</a> <a href="#%E5%BB%B6%E8%BF%9F%E8%84%9A%E6%9C%AC"></a>延迟脚本</h3> <p>Defer 属性指明本元素所含有的脚本不会修改 DOM ，因此当浏览器解析到对应的 <code>&lt;script&gt;</code> 标签是开始下载 JavaScript 文件（此时的 JavaScript 文件的下载不会阻塞其他资源文件的下载），但并不会立即执行，直到 DOM 加载完成（ onload 事件被触发前）。它不是一种跨浏览器的解决方案，因为该属性仅支持 IE 4+ 和 Firefox 3.5+ 的浏览器。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">defer</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'defer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
            window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
       </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上面的代码，在支持 defer 属性的浏览器中依次弹出 'script', 'defer', 'load'，在不支持 defer 属性的浏览器中依次弹出 'defer', 'script', 'load'。</p> <p><a name="RZEOB"></a></p> <h3 id="动态脚本元素"><a href="#动态脚本元素" aria-hidden="true" class="header-anchor">#</a> <a href="#%E5%8A%A8%E6%80%81%E8%84%9A%E6%9C%AC%E5%85%83%E7%B4%A0"></a>动态脚本元素</h3> <p>动态脚本加载可能是现今比较流行的优化技术了。由于 JavaScript 脚本可以对 DOM 进行增删改查，那创建 <code>&lt;script&gt;</code> 标签进行脚本引入也就自然而然了。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/javascript'</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'file1.js'</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这段脚本创建了一个 <code>&lt;script&gt;</code> 标签来加载 file1.js 文件。文件在该元素添加到页面时开始下载，并立即执行返回的脚本文件（除了 Firefox 和 Opera，他们会等待所有所有动态脚本节点执行完毕）。为了实现跨浏览器，我们将上面的脚本优化如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/javascript'</span><span class="token punctuation">;</span>
    
        <span class="token keyword">if</span><span class="token punctuation">(</span>script<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">//IE</span>
            <span class="token comment">//在 IE 浏览器中对 &lt;script&gt; 元素的接受会触发 readystatechange 事件</span>
            <span class="token comment">// &lt;script&gt; 元素提供了 readystate 属性，根据不同阶段，取值分别为 </span>
            <span class="token comment">// uninitialized =&gt; 初始化状态</span>
            <span class="token comment">// loading =&gt; 开始下载</span>
            <span class="token comment">// loaded =&gt; 下载完成</span>
            <span class="token comment">// interactive =&gt; 数据完成下载但上不可用</span>
            <span class="token comment">// complete =&gt; 所有数据已准备就绪</span>
            script<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>script<span class="token punctuation">.</span>readystate <span class="token operator">==</span> <span class="token string">'load'</span> <span class="token operator">||</span> script<span class="token punctuation">.</span>readystate <span class="token operator">==</span> <span class="token string">'complete'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    script<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>  <span class="token comment">//其他浏览器</span>
            script<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'file1.js'</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>上面的方法调用脚本加载形式如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">'file1.js'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'file1 is loaded!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">'file2.js'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'file2 is loaded!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><a name="JRJh2"></a></p> <h3 id="xmlhttprequest-脚本注入"><a href="#xmlhttprequest-脚本注入" aria-hidden="true" class="header-anchor">#</a> <a href="#xmlhttprequest-%E8%84%9A%E6%9C%AC%E6%B3%A8%E5%85%A5"></a>XMLHttpRequest 脚本注入</h3> <p>无阻塞脚本加载的方式是 XMLHttpRequest 脚本注入，此技术会创建一个 XHR 对象，然后用它下载 JavaScript 文件，最后通过创建动态的 <code>&lt;script&gt;</code> 元素将代码注入到页面当中。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'file1.js'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readystate <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">304</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/javascript'</span><span class="token punctuation">;</span>
                script<span class="token punctuation">.</span>text <span class="token operator">=</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">;</span>
                document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>代码发送一个 GET 请求获取 file1.js 源文件。事件处理函数 onreadystatechange 检查 readystate 是否为 4 ，同时校验 HTTP 状态码是否有效（ 2XX 表示有效响应，304 标识从缓存读取 ）。如果收到有效响应，就立即创建 <code>&lt;script&gt;</code> 元素，并设置该元素的 text 属性为从服务器端接收的 responseText，创建一个带内联脚本的 <code>&lt;script&gt;</code> 标签。</p> <p>这样做的好处是，可以自主的控制脚本执行的时机。由于脚本内容是在 <code>&lt;script&gt;</code> 标签之外的，因此下载后不会立即执行。还有就是同样的代码几乎所有的浏览器都能正常工作。这种方法主要的局限性是，JavaScript 文件必须和所请求的页面处于相同的域。</p> <p>管理浏览器中的 JavaScript 脚本是一个棘手的问题，由于 JavaScript 阻塞特性，通过以上的策略可以极大的提高需要大量使用 JavaScript 的 web 应用的实际性能。</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/24/2019, 8:47:05 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/" class="prev router-link-active">
          Home
        </a></span> <span class="next"><a href="/blog/SafeOptimize/0x01.html">
          函数节流
        </a>
        →
      </span></p></div> <div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div></div> <!----></div></div>
    <script src="/blog/assets/js/app.8628b115.js" defer></script><script src="/blog/assets/js/27.0fc3d0a8.js" defer></script>
  </body>
</html>
